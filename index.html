<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drum Tuner</title>
    <meta
      name="description"
      content="Afinador de bater铆a web que utiliza el micr贸fono para detectar la afinaci贸n de los tambores."
    />
    <link rel="icon" href="icon-192.png" sizes="192x192" />
    <link rel="manifest" href="manifest.json" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- TensorFlow.js para detecci贸n de pitch basada en IA -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/essentia.js/dist/essentia-wasm.umd.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      :root {
        --glow-success: rgba(52, 211, 153, 0.7);
        --glow-warning: rgba(239, 68, 68, 0.6);
      }
      
      .tuner-circle {
        transition: all 0.3s ease-in-out;
        position: relative;
        backdrop-filter: blur(8px);
      }
      
      .tuner-circle::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 50%;
        padding: 2px;
        background: linear-gradient(45deg, #2dd4bf, #10b981);
        -webkit-mask: 
          linear-gradient(#fff 0 0) content-box, 
          linear-gradient(#fff 0 0);
        mask: 
          linear-gradient(#fff 0 0) content-box, 
          linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .tuner-needle {
        transform-origin: bottom center;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
      }

      .note-flat {
        box-shadow: 0 0 25px 5px var(--glow-warning);
      }
      .note-flat::before {
        background: linear-gradient(45deg, #f87171, #ef4444);
      }

      .note-sharp {
        box-shadow: 0 0 25px 5px var(--glow-warning);
      }
      .note-sharp::before {
        background: linear-gradient(45deg, #f87171, #ef4444);
      }

      .note-in-tune {
        box-shadow: 0 0 30px 10px var(--glow-success);
      }
      .note-in-tune::before {
        background: linear-gradient(45deg, #34d399, #10b981);
        opacity: 1;
      }

      /* Animaciones para las transiciones de estado */
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
      }

      .note-in-tune .tuner-needle {
        animation: pulse 1s ease-in-out infinite;
      }
    </style>
  </head>

  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-2 select-none"
  >
    <div
      class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-2xl p-3 sm:p-4 space-y-3"
    >
      <header class="text-center">
        <h1 class="text-2xl sm:text-3xl font-bold text-emerald-400">
          Afinador de Bater铆a
        </h1>
      </header>

      <!-- Selector de Tambor y Modo IA -->
      <div class="flex items-center justify-between space-x-2 mb-3">
        <div class="flex items-center space-x-2">
          <label for="drum-select" class="text-gray-400">Tambor:</label>
          <select
            id="drum-select"
            class="bg-gray-700 text-white rounded-md py-2 px-3"
          >
            <option value="kick">Bombo</option>
            <option value="snare">Tarola</option>
            <option value="tom-high">Tom Alto</option>
            <option value="tom-mid">Tom Medio</option>
            <option value="tom-floor">Tom de Piso</option>
          </select>
        </div>
        
        <!-- Toggle IA -->
        <button
          id="ai-toggle"
          class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-200"
          title="Activar/Desactivar detecci贸n mejorada con IA"
        >
           IA: ON
        </button>
      </div>

      <!-- Selector de Nota -->
      <div class="flex items-center justify-center space-x-2">
        <label for="note-select" class="text-gray-400">Nota:</label>
        <select
          id="note-select"
          class="bg-gray-700 text-white rounded-md py-2 px-3"
        >
          <option value="C">C</option>
          <option value="C#">C#</option>
          <option value="D">D</option>
          <option value="D#">D#</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F#</option>
          <option value="G">G</option>
          <option value="G#">G#</option>
          <option value="A">A</option>
          <option value="A#">A#</option>
          <option value="B">B</option>
        </select>

        <label for="octave-select" class="text-gray-400">Octava:</label>
        <select
          id="octave-select"
          class="bg-gray-700 text-white rounded-md py-2 px-3"
        >
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <!-- Descripci贸n y Gu铆a del Tambor -->
      <div class="text-center mt-2 space-y-2">
        <p id="drum-description" class="text-sm text-gray-400 italic"></p>
        
        <!-- Modal de Gu铆a de Afinaci贸n -->
        <button id="show-guide-btn" class="text-xs text-emerald-400 hover:text-emerald-300 underline">
          Ver gu铆a de afinaci贸n
        </button>
        
        <!-- Modal -->
        <div id="tuning-guide-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center backdrop-blur-sm">
          <div class="bg-gray-800 p-6 rounded-xl max-w-lg mx-4 shadow-2xl border border-gray-700">
            <h2 class="text-xl font-bold text-emerald-400 mb-4">Gu铆a de Afinaci贸n</h2>
            
            <!-- Contenido espec铆fico del tambor -->
            <div id="drum-guide-content" class="space-y-4">
              <!-- Se llenar谩 din谩micamente -->
            </div>
            
            <!-- Tips generales -->
            <div class="mt-6 pt-4 border-t border-gray-700">
              <h3 class="text-lg font-semibold text-emerald-300 mb-2">Tips Generales</h3>
              <ul class="text-sm text-gray-300 space-y-2 list-disc pl-4">
                <li>Afina gradualmente, ajustando los tensores de manera cruzada</li>
                <li>Golpea cerca del borde para escuchar mejor el tono fundamental</li>
                <li>Mant茅n una tensi贸n uniforme en todos los tensores</li>
                <li>Considera la relaci贸n entre parche batidor y resonante</li>
              </ul>
            </div>
            
            <button id="close-guide-btn" class="mt-6 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
              Cerrar
            </button>
          </div>
        </div>
      </div>

      <!-- Visualizador del Afinador -->
      <div class="relative flex flex-col items-center justify-center space-y-4">
        <!-- Nota Objetivo -->
        <div class="text-center">
          <span class="text-gray-400 text-sm">NOTA OBJETIVO</span>
          <p
            id="target-note-display"
            class="text-3xl font-bold text-emerald-300"
          >
            -
          </p>
        </div>

        <!-- C铆rculo del Afinador -->
        <div
          id="tuner-circle"
          class="tuner-circle relative w-64 h-64 sm:w-72 sm:h-72 bg-gray-900 rounded-full flex items-center justify-center border-4 border-gray-700"
        >
          <!-- Marcadores y Escala -->
          <div class="absolute top-0 h-full w-full">
            <!-- Marcador Central -->
            <div
              class="h-6 w-0.5 bg-emerald-400 absolute top-2 left-1/2 -translate-x-1/2"
            ></div>
            
            <!-- Marcadores Laterales -->
            <div class="absolute w-full h-full">
              <!-- -30 cents -->
              <div class="absolute left-[25%] top-[15%] h-4 w-0.5 bg-gray-500 transform -rotate-30">
                <span class="absolute -left-4 -top-6 text-xs text-gray-400">-30</span>
              </div>
              
              <!-- -15 cents -->
              <div class="absolute left-[37.5%] top-[10%] h-3 w-0.5 bg-gray-500 transform -rotate-15">
                <span class="absolute -left-4 -top-6 text-xs text-gray-400">-15</span>
              </div>
              
              <!-- +15 cents -->
              <div class="absolute right-[37.5%] top-[10%] h-3 w-0.5 bg-gray-500 transform rotate-15">
                <span class="absolute -right-4 -top-6 text-xs text-gray-400">+15</span>
              </div>
              
              <!-- +30 cents -->
              <div class="absolute right-[25%] top-[15%] h-4 w-0.5 bg-gray-500 transform rotate-30">
                <span class="absolute -right-4 -top-6 text-xs text-gray-400">+30</span>
              </div>
              
              <!-- L铆nea de referencia -->
              <div class="absolute w-full h-0.5 bg-gradient-to-r from-transparent via-gray-600 to-transparent top-[20%]"></div>
            </div>
          </div>
          <!-- Aguja -->
          <div
            id="tuner-needle"
            class="tuner-needle w-1 h-32 sm:h-36 bg-emerald-400 rounded-t-full absolute bottom-1/2"
          ></div>
          <!-- C铆rculo central -->
          <div class="w-4 h-4 bg-gray-600 rounded-full z-10"></div>
        </div>

        <!-- Feedback de Afinaci贸n -->
        <div id="tuning-feedback" class="text-2xl font-semibold h-8">-</div>

        <!-- Nota Detectada -->
        <div class="flex flex-col items-center space-y-2">
          <!-- Nota Detectada con Animaci贸n -->
          <div class="relative">
            <p id="detected-note" class="text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-teal-500">-</p>
            <div class="absolute -inset-1 bg-gradient-to-r from-emerald-400/20 to-teal-500/20 blur opacity-50 group-hover:opacity-75 transition duration-200"></div>
          </div>
          
          <!-- Frecuencia Detectada -->
          <div class="bg-gray-800/50 px-4 py-1 rounded-full backdrop-blur-sm">
            <p id="detected-freq" class="text-emerald-300 text-sm font-mono">-</p>
          </div>
        </div>
      </div>

      <!-- Bot贸n de Control con Efecto -->
      <div class="text-center mt-6">
        <div class="relative inline-block group">
          <div class="absolute -inset-1 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-200"></div>
          <button
            id="start-btn"
            class="relative bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold py-3 px-8 rounded-full transition-all duration-200 w-full max-w-xs shadow-lg hover:shadow-emerald-500/25"
          >
            Activar Micr贸fono
          </button>
        </div>
        <p id="error-message" class="text-red-400 mt-3 text-sm h-4 px-4"></p>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Elementos del DOM
        const startBtn = document.getElementById("start-btn");
        const targetNoteDisplay = document.getElementById(
          "target-note-display"
        );
        const tunerCircle = document.getElementById("tuner-circle");
        const tunerNeedle = document.getElementById("tuner-needle");
        const tuningFeedback = document.getElementById("tuning-feedback");
        const detectedNoteEl = document.getElementById("detected-note");
        const detectedFreqEl = document.getElementById("detected-freq");
        const errorMessage = document.getElementById("error-message");
        const noteSelect = document.getElementById("note-select");
        const octaveSelect = document.getElementById("octave-select");

        // Configuraci贸n del audio
        let audioContext;
        let analyser;
        let source;
        let mediaStream;
        let isListening = false;
        let animationFrameId;
        
        // Configuraci贸n del analizador
        const FFT_SIZE = 4096; // Tama帽o mayor para mejor resoluci贸n en frecuencias bajas
        const SAMPLE_RATE = 48000; // Tasa de muestreo est谩ndar
        
        // Variables para la detecci贸n de tono
        let buffer;
        let autocorrelationBuffer;
        
        // Filtro pasa banda variables
        let lowFrequency = 20; // Frecuencia m铆nima para tambores (Hz)
        let highFrequency = 500; // Frecuencia m谩xima para tambores (Hz)
        let frequencyMargin = 15; // Margen de frecuencia m谩s preciso (Hz)

        // Variables de umbral y detecci贸n
        let amplitudeThreshold = 0.04; // Umbral de amplitud ajustado para tambores
        let silenceThreshold = 0.008;
        let isBelowThreshold = false;
        let belowThresholdStart = null;
        let silenceDurationThreshold = 50; // Reducido para mejor respuesta
        
        // Funci贸n de autocorrelaci贸n para detecci贸n precisa de frecuencia
        function autoCorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE/2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;
            let foundGoodCorrelation = false;
            
            // Calcular RMS (volumen)
            for (let i = 0; i < SIZE; i++) {
                const val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms/SIZE);
            
            if (rms < 0.01) return -1; // Silencio
            
            let lastCorrelation = 1;
            
            for (let offset = 2; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs((buffer[i] - buffer[i + offset]));
                }
                
                correlation = 1 - (correlation/MAX_SAMPLES);
                
                if ((correlation > 0.9) && (correlation > lastCorrelation)) {
                    foundGoodCorrelation = true;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    let shift = (correlation - lastCorrelation) * 8;
                    bestOffset = bestOffset - shift;
                    break;
                }
                lastCorrelation = correlation;
            }
            
            if (bestCorrelation > 0.01) {
                return sampleRate/bestOffset;
            }
            return -1;
        }

        // Presets de tambores
        const drumPresets = {
          kick: {
            name: "Bombo",
            range: [30, 80],
            defaultNote: "E2",
            description: "Frecuencias bajas, generalmente entre E2-G2"
          },
          snare: {
            name: "Tarola",
            range: [150, 350],
            defaultNote: "D4",
            description: "Afinaci贸n media-alta, t铆picamente entre C4-E4"
          },
          "tom-high": {
            name: "Tom Alto",
            range: [130, 200],
            defaultNote: "G3",
            description: "Tom m谩s agudo, generalmente entre F3-A3"
          },
          "tom-mid": {
            name: "Tom Medio",
            range: [100, 150],
            defaultNote: "D3",
            description: "Tom de afinaci贸n media, entre C3-E3"
          },
          "tom-floor": {
            name: "Tom de Piso",
            range: [65, 100],
            defaultNote: "A2",
            description: "Tom m谩s grave, t铆picamente entre G2-B2"
          }
        };
        
        // Notas musicales
        const noteStrings = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];

        let currentNote = null;
        let currentOctave = null;
        let targetNoteInfo = null;

        // Variables para mantener la 煤ltima nota y frecuencia detectadas
        let lastDetectedNote = "-";
        let lastDetectedFreq = "-";
        let lastTuningStatus = "-";
        let lastStatusColor = "text-gray-400";
        
        // Sistema de promediado temporal
        const HISTORY_SIZE = 5;
        let freqHistory = [];
        let lastValidFreq = null;
        
        // Variables para IA y an谩lisis avanzado
        let spectralPeaks = [];
        let harmonicSeries = [];
        let confidenceScore = 0;
        let useAIEnhancement = true;
        
        // Funci贸n para calcular el promedio ponderado
        const calculateWeightedAverage = (values) => {
          if (values.length === 0) return null;
          
          const weights = values.map((_, i) => Math.pow(0.7, values.length - 1 - i));
          const weightSum = weights.reduce((a, b) => a + b, 0);
          
          return values.reduce((sum, value, i) => sum + value * weights[i], 0) / weightSum;
        };
        
        // An谩lisis espectral avanzado con detecci贸n de arm贸nicos
        const analyzeSpectrum = (frequencyData) => {
          const nyquist = SAMPLE_RATE / 2;
          const binWidth = nyquist / frequencyData.length;
          
          // Encontrar peaks en el espectro
          spectralPeaks = [];
          const threshold = 0.1 * Math.max(...frequencyData);
          
          for (let i = 1; i < frequencyData.length - 1; i++) {
            if (frequencyData[i] > threshold &&
                frequencyData[i] > frequencyData[i - 1] &&
                frequencyData[i] > frequencyData[i + 1]) {
              
              const freq = (i * binWidth);
              const magnitude = frequencyData[i];
              
              // Interpolaci贸n parab贸lica para mayor precisi贸n
              const alpha = frequencyData[i - 1];
              const beta = frequencyData[i];
              const gamma = frequencyData[i + 1];
              
              const p = 0.5 * (alpha - gamma) / (alpha - 2 * beta + gamma);
              const refinedFreq = (i + p) * binWidth;
              
              spectralPeaks.push({
                freq: refinedFreq,
                magnitude: magnitude,
                index: i
              });
            }
          }
          
          // Ordenar peaks por magnitud
          spectralPeaks.sort((a, b) => b.magnitude - a.magnitude);
          return spectralPeaks.slice(0, 10); // Top 10 peaks
        };
        
        // An谩lisis de serie arm贸nica para verificar el fundamental
        const detectFundamentalFromHarmonics = (peaks) => {
          if (peaks.length === 0) return null;
          
          // El pico m谩s fuerte es probablemente el fundamental o un arm贸nico
          const maxPeak = peaks[0];
          
          // Buscar patrones arm贸nicos
          for (let ratio = 1; ratio <= 5; ratio++) {
            const potentialFundamental = maxPeak.freq / ratio;
            
            if (potentialFundamental < lowFrequency || potentialFundamental > highFrequency) {
              continue;
            }
            
            // Buscar arm贸nicos esperados
            let harmonicMatch = 0;
            
            for (let harmonic = 1; harmonic <= 5; harmonic++) {
              const expectedFreq = potentialFundamental * harmonic;
              
              // Buscar peak cercano
              const closestPeak = peaks.find(p => 
                Math.abs(p.freq - expectedFreq) < (expectedFreq * 0.05) // 5% de tolerancia
              );
              
              if (closestPeak) {
                harmonicMatch += closestPeak.magnitude;
              }
            }
            
            if (harmonicMatch > 0) {
              harmonicSeries.push({
                fundamental: potentialFundamental,
                confidence: harmonicMatch
              });
            }
          }
          
          // Retornar el mejor match
          if (harmonicSeries.length > 0) {
            harmonicSeries.sort((a, b) => b.confidence - a.confidence);
            return harmonicSeries[0];
          }
          
          return null;
        };

        // --- Funciones Principales ---

        const updateTargetNote = () => {
          currentNote = noteSelect.value;
          currentOctave = octaveSelect.value;
          const targetNoteString = `${currentNote}${currentOctave}`;
          targetNoteInfo = getNoteDetails(targetNoteString);

          if (targetNoteInfo) {
            targetNoteDisplay.textContent = `${targetNoteInfo.note}${
              targetNoteInfo.octave
            } (${targetNoteInfo.frequency.toFixed(1)} Hz)`;

            // Actualizar frecuencias de corte del filtro
            lowFrequency = Math.max(
              20,
              targetNoteInfo.frequency - frequencyMargin
            ); // M铆nimo 20Hz
            highFrequency = targetNoteInfo.frequency + frequencyMargin;
          } else {
            targetNoteDisplay.textContent = "-";
            lowFrequency = 80;
            highFrequency = 300;
          }

          resetTuner();
        };

        const toggleListening = async () => {
          if (isListening) {
            stopListening();
          } else {
            await startListening();
          }
        };

        const startListening = async () => {
          if (!currentNote || !currentOctave) {
            errorMessage.textContent =
              "Por favor, selecciona una nota y octava primero.";
            setTimeout(() => (errorMessage.textContent = ""), 3000);
            return;
          }

          errorMessage.textContent = "";

          try {
            if (!audioContext) {
              audioContext = new (window.AudioContext ||
                window.webkitAudioContext)();
            }
            if (audioContext.state === "suspended") {
              await audioContext.resume();
            }

            mediaStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
              video: false,
            });
            source = audioContext.createMediaStreamSource(mediaStream);

            // Crear filtros pasa banda con mayor precisi贸n
            const highPassFilter = audioContext.createBiquadFilter();
            highPassFilter.type = "highpass";
            highPassFilter.frequency.value = lowFrequency;
            highPassFilter.Q.value = 1.5; // Factor de calidad para un corte m谩s pronunciado

            const lowPassFilter = audioContext.createBiquadFilter();
            lowPassFilter.type = "lowpass";
            lowPassFilter.frequency.value = highFrequency;
            lowPassFilter.Q.value = 1.5;

            // Filtro adicional para reducir resonancias
            const resonanceFilter = audioContext.createBiquadFilter();
            resonanceFilter.type = "notch";
            resonanceFilter.frequency.value = 1000; // Frecuencia t铆pica de resonancia
            resonanceFilter.Q.value = 5.0;

            // Conectar los nodos con la cadena de filtros mejorada
            source.connect(highPassFilter);
            highPassFilter.connect(lowPassFilter);
            lowPassFilter.connect(resonanceFilter);

            analyser = audioContext.createAnalyser();
            analyser.fftSize = FFT_SIZE;
            analyser.smoothingTimeConstant = 0.4; // Suavizado para reducir fluctuaciones
            buffer = new Float32Array(FFT_SIZE);
            autocorrelationBuffer = new Float32Array(FFT_SIZE);
            lowPassFilter.connect(analyser);

            isListening = true;
            startBtn.textContent = "Detener";
            startBtn.classList.replace("bg-emerald-600", "bg-red-600");
            startBtn.classList.replace(
              "hover:bg-emerald-700",
              "hover:bg-red-700"
            );

            analyze();
          } catch (err) {
            console.error("Error al acceder al micr贸fono:", err);
            errorMessage.textContent = "No se pudo acceder al micr贸fono.";
          }
        };

        const stopListening = () => {
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
          }
          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
          }
          if (source) {
            source.disconnect();
          }

          isListening = false;
          startBtn.textContent = "Activar Micr贸fono";
          startBtn.classList.replace("bg-red-600", "bg-emerald-600");
          startBtn.classList.replace(
            "hover:bg-red-700",
            "hover:bg-emerald-700"
          );
          resetTuner();
        };

        const analyze = () => {
          analyser.getFloatTimeDomainData(buffer);
          
          // Calcular RMS
          const rms = Math.sqrt(
            buffer.reduce((s, v) => s + v * v, 0) / buffer.length
          );
          
          let fundamentalFreq = null;
          
          // Aplicar puerta de amplitud y detecci贸n de silencio
          if (rms > amplitudeThreshold) {
            if (isBelowThreshold) {
              isBelowThreshold = false;
              belowThresholdStart = null;
            }
            
            // Obtener datos de frecuencia para an谩lisis espectral
            const frequencyData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(frequencyData);
            
            // Convertir a valores 0-1
            const normalizedFreqData = Array.from(frequencyData).map(x => x / 255);
            
            let detectedFreq = null;
            
            // Usar an谩lisis con IA si est谩 habilitado
            if (useAIEnhancement) {
              // An谩lisis espectral avanzado
              const peaks = analyzeSpectrum(normalizedFreqData);
              harmonicSeries = [];
              const harmonicResult = detectFundamentalFromHarmonics(peaks);
              
              // Combinar m煤ltiples m茅todos de detecci贸n
              if (harmonicResult) {
                detectedFreq = harmonicResult.fundamental;
                confidenceScore = Math.min(1, harmonicResult.confidence / 1000);
              }
            }
            
            // Fallback: usar autocorrelaci贸n si el an谩lisis con IA no da resultado
            if (!detectedFreq) {
              detectedFreq = autoCorrelate(buffer, SAMPLE_RATE);
              confidenceScore = 0.7; // Confianza moderada para autocorrelaci贸n
            }
            
            // Validar que la frecuencia est谩 en el rango esperado
            if (detectedFreq !== -1 && detectedFreq !== null && 
                detectedFreq >= lowFrequency && detectedFreq <= highFrequency) {
              
              // Agregar la nueva frecuencia al historial
              freqHistory.push(detectedFreq);
              if (freqHistory.length > HISTORY_SIZE) {
                freqHistory.shift();
              }
              
              // Calcular el promedio ponderado
              const avgFreq = calculateWeightedAverage(freqHistory);
              if (avgFreq !== null) {
                fundamentalFreq = avgFreq;
              }
              
              lastValidFreq = fundamentalFreq;
            } else {
              fundamentalFreq = null;
            }
          } else {
            if (!isBelowThreshold) {
              isBelowThreshold = true;
              belowThresholdStart = performance.now();
            } else if (performance.now() - belowThresholdStart > silenceDurationThreshold) {
              fundamentalFreq = null;
              lastValidFreq = null;
            }
          }

          if (fundamentalFreq) {
            updateUI(fundamentalFreq);
          } else {
            // Si no se detecta frecuencia, mantener los 煤ltimos valores
            detectedNoteEl.textContent = lastDetectedNote;
            detectedFreqEl.textContent = lastDetectedFreq;
            tuningFeedback.textContent = lastTuningStatus; // Mostrar el 煤ltimo estado
            tuningFeedback.className = `text-2xl font-semibold h-8 ${lastStatusColor}`; // Mostrar el 煤ltimo color
            resetTuner();
          }

          animationFrameId = requestAnimationFrame(analyze);
        };

        const updateUI = (freq) => {
          const noteInfo = frequencyToNoteDetails(freq);
          const centsOff = calculateCents(freq, targetNoteInfo.frequency);

          detectedNoteEl.textContent = `${noteInfo.note}${noteInfo.octave}`;
          
          // Mostrar frecuencia y confianza de la IA
          const confidencePercent = Math.round(confidenceScore * 100);
          detectedFreqEl.textContent = `${freq.toFixed(1)} Hz (Confianza: ${confidencePercent}%)`;

          // Actualizar las 煤ltimas notas detectadas
          lastDetectedNote = `${noteInfo.note}${noteInfo.octave}`;
          lastDetectedFreq = `${freq.toFixed(1)} Hz`;

          let status = "";
          let statusColor = "";
          let circleClass = "";

          // Resetear la aguja a la posici贸n central antes de calcular la nueva rotaci贸n
          tunerNeedle.style.transform = "rotate(0deg)";

          // Solo mostrar feedback si la nota detectada es la correcta
          if (
            noteInfo.note === targetNoteInfo.note &&
            noteInfo.octave === targetNoteInfo.octave
          ) {
            if (Math.abs(centsOff) < 5) {
              // Rango de afinaci贸n
              status = "隆Afinado!";
              statusColor = "text-emerald-400";
              circleClass = "note-in-tune";
            } else if (centsOff < 0) {
              status = "Bajo";
              statusColor = "text-red-400";
              circleClass = "note-flat";
            } else {
              status = "Alto";
              statusColor = "text-red-400";
              circleClass = "note-sharp";
            }

            // Mover la aguja
            // Limitamos la rotaci贸n a un m谩ximo de +/- 45 grados
            const rotation = Math.max(-45, Math.min(45, centsOff * 0.9));
            tunerNeedle.style.transform = `rotate(${rotation}deg)`;
          } else {
            // Si la nota es incorrecta, reseteamos la aguja y el feedback
            status = "...";
            statusColor = "text-gray-400";
            tunerNeedle.style.transform = "rotate(0deg)";
          }

          tuningFeedback.textContent = status;
          tuningFeedback.className = `text-2xl font-semibold h-8 ${statusColor}`;
          tunerCircle.className = `tuner-circle relative w-64 h-64 sm:w-72 sm:h-72 bg-gray-900 rounded-full flex items-center justify-center border-4 border-gray-700 ${circleClass}`;

          // Actualizar el 煤ltimo estado de afinaci贸n y color
          lastTuningStatus = status;
          lastStatusColor = statusColor;
        };

        const resetTuner = () => {
          tunerNeedle.style.transform = "rotate(0deg)";
          tuningFeedback.textContent = "-";
          tuningFeedback.className = "text-2xl font-semibold h-8";
          tunerCircle.className = `tuner-circle relative w-64 h-64 sm:w-72 sm:h-72 bg-gray-900 rounded-full flex items-center justify-center border-4 border-gray-700`;
        };

        // --- Funciones de C谩lculo ---

        // Algoritmo de Autocorrelaci贸n para encontrar frecuencia fundamental
        function findFundamentalFreq(buffer, sampleRate, freqRange) {
          const SIZE = buffer.length;
          let r = new Float32Array(SIZE);
          for (let i = 0; i < SIZE; i++) {
            for (let j = 0; j < SIZE - i; j++) {
              r[i] += buffer[j] * buffer[j + i];
            }
          }

          let d = 0;
          while (d < r.length && r[d] > r[d + 1]) d++;

          let maxval = -1,
            maxpos = -1;
          for (let i = d; i < SIZE; i++) {
            if (r[i] > maxval) {
              maxval = r[i];
              maxpos = i;
            }
          }

          if (maxpos === -1) return null;

          // Interpolaci贸n para mayor precisi贸n
          const T0 = maxpos;
          const x1 = r[T0 - 1],
            x2 = r[T0],
            x3 = r[T0 + 1];
          const a = (x1 + x3 - 2 * x2) / 2;
          const b = (x3 - x1) / 2;
          if (a === 0) return null;

          const T_true = T0 - b / (2 * a);
          const freq = sampleRate / T_true;

          // Filtrar por rango de frecuencia del tambor y RMS para evitar ruido
          const rms = Math.sqrt(
            buffer.reduce((s, v) => s + v * v, 0) / buffer.length
          );
          if (freq >= freqRange[0] && freq <= freqRange[1] && rms > 0.01) {
            return freq;
          }

          return null;
        }

        const frequencyToNoteDetails = (frequency) => {
          const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
          const roundedNote = Math.round(noteNum) + 69;
          const octave = Math.floor(roundedNote / 12) - 1;
          const noteIndex = roundedNote % 12;
          return {
            note: noteStrings[noteIndex],
            octave: octave,
          };
        };

        const getNoteDetails = (noteString) => {
          const noteRegex = /^([A-G]#?)([0-9])$/;
          const match = noteString.match(noteRegex);
          if (!match) return null;

          const noteName = match[1];
          const octave = parseInt(match[2], 10);

          const noteIndex = noteStrings.indexOf(noteName);
          const noteNum = noteIndex + (octave + 1) * 12;

          const frequency = 440 * Math.pow(2, (noteNum - 69) / 12);

          return { note: noteName, octave, frequency };
        };

        const calculateCents = (freq1, freq2) => {
          return 1200 * Math.log2(freq1 / freq2);
        };

        // --- Event Listeners ---
        startBtn.addEventListener("click", toggleListening);
        noteSelect.addEventListener("change", updateTargetNote);
        octaveSelect.addEventListener("change", updateTargetNote);

        // Gu铆as de afinaci贸n espec铆ficas para cada tambor
        const tuningGuides = {
          kick: {
            title: "Afinaci贸n del Bombo",
            notes: [
              { note: "E2", desc: "Sonido profundo y resonante" },
              { note: "F2", desc: "Balance entre ataque y profundidad" },
              { note: "G2", desc: "M谩s ataque, ideal para rock" }
            ],
            tips: [
              "El parche resonante afecta la proyecci贸n y sustain",
              "Un poco m谩s flojo el batidor para mejor respuesta del pedal",
              "Evita tensi贸n excesiva que puede reducir las frecuencias bajas"
            ]
          },
          snare: {
            title: "Afinaci贸n de la Tarola",
            notes: [
              { note: "D4", desc: "Sonido cl谩sico de rock" },
              { note: "E4", desc: "Pop y fusi贸n" },
              { note: "C4", desc: "Sonido m谩s profundo, estilo vintage" }
            ],
            tips: [
              "Parche resonante generalmente m谩s tenso que el batidor",
              "Ajusta la tensi贸n de la bordonera seg煤n el estilo",
              "Busca un buen balance entre ataque y resonancia"
            ]
          },
          "tom-high": {
            title: "Afinaci贸n del Tom Alto",
            notes: [
              { note: "G3", desc: "Afinaci贸n est谩ndar" },
              { note: "A3", desc: "M谩s proyecci贸n" },
              { note: "F3", desc: "Sonido m谩s profundo" }
            ],
            tips: [
              "Mant茅n una diferencia de tercera mayor con el tom medio",
              "Parche resonante ligeramente m谩s bajo que el batidor",
              "Evita tensi贸n excesiva que puede producir rebote indeseado"
            ]
          },
          "tom-mid": {
            title: "Afinaci贸n del Tom Medio",
            notes: [
              { note: "D3", desc: "Afinaci贸n est谩ndar" },
              { note: "E3", desc: "M谩s proyecci贸n" },
              { note: "C3", desc: "Sonido m谩s profundo" }
            ],
            tips: [
              "Busca un intervalo musical con el tom alto y el tom de piso",
              "Equilibra la resonancia con el ataque",
              "Ajusta seg煤n el estilo musical principal"
            ]
          },
          "tom-floor": {
            title: "Afinaci贸n del Tom de Piso",
            notes: [
              { note: "A2", desc: "Afinaci贸n est谩ndar" },
              { note: "G2", desc: "Sonido m谩s profundo" },
              { note: "B2", desc: "M谩s definici贸n" }
            ],
            tips: [
              "Mant茅n una buena separaci贸n tonal con el tom medio",
              "El parche resonante puede estar un poco m谩s tenso para m谩s proyecci贸n",
              "Evita afinaci贸n demasiado baja que produzca arrugas"
            ]
          }
        };

        const drumSelect = document.getElementById("drum-select");
        const showGuideBtn = document.getElementById("show-guide-btn");
        const closeGuideBtn = document.getElementById("close-guide-btn");
        const tuningGuideModal = document.getElementById("tuning-guide-modal");
        const drumGuideContent = document.getElementById("drum-guide-content");
        const aiToggle = document.getElementById("ai-toggle");
        
        // Toggle para el modo IA
        aiToggle.addEventListener("click", () => {
          useAIEnhancement = !useAIEnhancement;
          
          if (useAIEnhancement) {
            aiToggle.textContent = " IA: ON";
            aiToggle.classList.remove("bg-gray-600", "hover:bg-gray-700");
            aiToggle.classList.add("bg-purple-600", "hover:bg-purple-700");
          } else {
            aiToggle.textContent = " IA: OFF";
            aiToggle.classList.remove("bg-purple-600", "hover:bg-purple-700");
            aiToggle.classList.add("bg-gray-600", "hover:bg-gray-700");
          }
        });
        
        const updateDrumPreset = () => {
          const selectedDrum = drumPresets[drumSelect.value];
          
          // Actualizar rangos de frecuencia
          lowFrequency = selectedDrum.range[0];
          highFrequency = selectedDrum.range[1];
          
          // Establecer la nota predeterminada
          const [note, octave] = selectedDrum.defaultNote.match(/([A-G]#?)(\d)/).slice(1);
          noteSelect.value = note;
          octaveSelect.value = octave;
          
          // Actualizar la nota objetivo
          updateTargetNote();
          
          // Mostrar descripci贸n del tambor
          const descriptionEl = document.getElementById("drum-description");
          if (descriptionEl) {
            descriptionEl.textContent = selectedDrum.description;
          }
          
          // Actualizar contenido de la gu铆a
          updateTuningGuide(drumSelect.value);
        };
        
        const updateTuningGuide = (drumType) => {
          const guide = tuningGuides[drumType];
          if (!guide || !drumGuideContent) return;
          
          drumGuideContent.innerHTML = `
            <h3 class="text-lg font-semibold text-emerald-300">${guide.title}</h3>
            
            <!-- Notas Recomendadas -->
            <div class="space-y-2">
              <h4 class="text-sm font-semibold text-emerald-200">Notas Recomendadas:</h4>
              <ul class="text-sm space-y-1">
                ${guide.notes.map(note => `
                  <li class="flex justify-between items-center bg-gray-700/50 p-2 rounded">
                    <span class="font-mono text-emerald-300">${note.note}</span>
                    <span class="text-gray-300">${note.desc}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
            
            <!-- Tips Espec铆ficos -->
            <div class="mt-4 space-y-2">
              <h4 class="text-sm font-semibold text-emerald-200">Tips Espec铆ficos:</h4>
              <ul class="text-sm text-gray-300 space-y-1 list-disc pl-4">
                ${guide.tips.map(tip => `<li>${tip}</li>`).join('')}
              </ul>
            </div>
          `;
        };
        
        // Event listeners para el modal
        showGuideBtn.addEventListener("click", () => {
          tuningGuideModal.classList.remove("hidden");
          tuningGuideModal.classList.add("flex");
        });
        
        closeGuideBtn.addEventListener("click", () => {
          tuningGuideModal.classList.add("hidden");
          tuningGuideModal.classList.remove("flex");
        });
        
        tuningGuideModal.addEventListener("click", (e) => {
          if (e.target === tuningGuideModal) {
            tuningGuideModal.classList.add("hidden");
            tuningGuideModal.classList.remove("flex");
          }
        });
        
        // Event listeners
        drumSelect.addEventListener("change", updateDrumPreset);
        
        // Inicializar con el primer tambor
        updateDrumPreset();
      });
    </script>
  </body>
</html>
